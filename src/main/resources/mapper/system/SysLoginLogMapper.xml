<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cloud.topdaddy.admin.mapper.SysLoginLogMapper">

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, username, ip, location, user_agent, status, message, login_time
    </sql>

    <!-- 根据用户名查询登录日志 -->
    <select id="selectByUsername" parameterType="string" resultType="cloud.topdaddy.admin.entity.SysLoginLog">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_login_log
        WHERE username = #{username}
        ORDER BY login_time DESC
    </select>

    <!-- 根据IP地址查询登录日志 -->
    <select id="selectByIp" parameterType="string" resultType="cloud.topdaddy.admin.entity.SysLoginLog">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_login_log
        WHERE ip = #{ip}
        ORDER BY login_time DESC
    </select>

    <!-- 根据时间范围查询登录日志 -->
    <select id="selectByTimeRange" resultType="cloud.topdaddy.admin.entity.SysLoginLog">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_login_log
        WHERE login_time BETWEEN #{startTime} AND #{endTime}
        ORDER BY login_time DESC
    </select>

    <!-- 根据状态查询登录日志 -->
    <select id="selectByStatus" parameterType="int" resultType="cloud.topdaddy.admin.entity.SysLoginLog">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_login_log
        WHERE status = #{status}
        ORDER BY login_time DESC
    </select>

    <!-- 清理指定天数之前的日志 -->
    <delete id="deleteByDaysAgo" parameterType="int">
        DELETE FROM sys_login_log
        WHERE login_time &lt; DATE_SUB(NOW(), INTERVAL #{days} DAY)
    </delete>

    <!-- 统计登录日志数量 -->
    <select id="countLogs" resultType="long">
        SELECT COUNT(*) FROM sys_login_log
    </select>

    <!-- 统计今日登录日志数量 -->
    <select id="countTodayLogs" resultType="long">
        SELECT COUNT(*) FROM sys_login_log
        WHERE DATE(login_time) = CURDATE()
    </select>

    <!-- 统计失败登录日志数量 -->
    <select id="countFailedLogs" resultType="long">
        SELECT COUNT(*) FROM sys_login_log
        WHERE status = 0
    </select>

    <!-- 统计最近登录的用户数量 -->
    <select id="countRecentUsers" parameterType="int" resultType="long">
        SELECT COUNT(DISTINCT username)
        FROM sys_login_log
        WHERE status = 1
          AND login_time >= DATE_SUB(NOW(), INTERVAL #{hours} HOUR)
    </select>
</mapper>
